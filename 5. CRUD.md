# 5. CRUD
## Generate the code
Generate a resource, with generated CRUD endpoints (code first GraphQL)
```bash
nest g resource <name>
```
Set the name to owners

Select “GraphQL (code first)”

Generate CRUD entry points? → Yes

## Entity Definition
Same as pets entity difinition.

Set up database relationship.


## CRUD
### The Read of CRUD
Find queries are pretty straightforward:

```typescript
// users.resolver.ts

@Query(() => [User], { name: 'users' })
async findAll(): Promise<User[]> {
  return this.usersService.findAll();
}

@Query(() => User, { name: 'user' })
async findOne(
  @Args('uuid', { type: () => String }) uuid: string,
): Promise<User> {
  return this.usersService.findOne(uuid);
}
```

```typescript
// users.service.ts

async findAll() {
  return this.userRepo.find();
}

async findOne(uuid: string) {
  return this.userRepo.findOneBy({ uuid });
}
```

### The Update of CRUD
Define update DTO first, same as create DTO.

```typescript
// update-user.input.ts

@InputType()
export default class UpdateUserInput extends PartialType(CreateUserInput) {
  @Field(() => String)
  uuid: string;
}
```

For update mutation, for a minimal version we can just return the count of affected rows:
```typescript
// users.resolver.ts

@Mutation(() => Int)
async updateUser(
  @Args('updateUserInput') updateUserInput: UpdateUserInput,
): Promise<number> {
  return this.usersService.update(updateUserInput.uuid, updateUserInput);
}
```
```typescript
// users.service.ts

async update(uuid: string, updateUserInput: UpdateUserInput) {
    return (await this.userRepo.update({ uuid }, updateUserInput)).affected;
}
```
Alternatively, we may want to return the updated User from the update mutation
```typescript
// users.service.ts

import * as _ from 'lodash';

async update(uuid: string, updateUserInput: UpdateUserInput) {
  const result = await this.userRepo
    .createQueryBuilder()
    .update(User)
    .set(updateUserInput)
    .where({ uuid })
    .returning('*')
    .execute();
  return result.raw[0]
    ? _.mapKeys(result.raw[0], (_v: any, k: any) => _.camelCase(k))
    : null;
 }
```
### The Delete of CRUD

```typescript
// users.resolver.ts

@Mutation(() => Int)
async removeUser(@Args('uuid', { type: () => String }) uuid: string) {
  return this.usersService.remove(uuid);
}
```
```typescript
// users.service.ts

async remove(uuid: string) {
  return (await this.userRepo.delete(uuid)).affected;
}
```
